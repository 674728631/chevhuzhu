<%@ page language="java" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="ctx" value="${pageContext.request.contextPath}"></c:set>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>车V互助后台管理系统</title>
    <jsp:include page="/pages/branch/head.jsp"/>
</head>
<body>
<div id="wrapper">
    <!-- Sidebar -->
    <nav class="navbar navbar-fixed-top navbar-inverse main-nav" role="navigation">
        <jsp:include page="/pages/branch/mobile.jsp"/>
        <jsp:include page="/pages/branch/left.jsp"/>
    </nav>
    <!--主体内容-->
    <div id="page-wrapper">
        <div class="position-row">
            <ul class="breadcrumb index-bread col-xs-12">
                <%--<li><a href="${ctx}/main.html"><i class="fa fa-dashboard"></i> 首页</a></li>--%>
                <li><i class="fa fa-dashboard"></i> 营销</li>
                <li>营销统计</li>
            </ul>
        </div>
        <div class="datebox-pick clearfix">
            <p class="datebox-title">时间：</p>
            <div class="datebox-btn" style="position:relative;float:left;display: inline-block;margin-left:0px;">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" value="-1"><span class="btn-title">今日</span> <span class="caret"></span></button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <li><a href="javascript:;">今日</a></li>
                    <li><a href="javascript:;">昨日</a></li>
                    <li><a href="javascript:;">上一周</a></li>
                    <li><a href="javascript:;">自定义</a></li>
                </ul>
            </div>
        </div>
        <div class="base-count">
            <ul class="base-list clearfix">
                <li><p class="base-num num1">${weChatConcernNum}</p><p class="base-desc">微信关注</p></li>
                <li><p class="base-num num2">${registerNum}</p><p class="base-desc">注册</p></li>
                <li><p class="base-num num3">${observationNum}</p><p class="base-desc">观察期</p></li>
                <li><p class="base-num num4">${guaranteeNum}</p><p class="base-desc">保障中</p></li>
                <li><p class="base-num num5">${rechargeNum}</p><p class="base-desc">充值笔数</p></li>
                <li><p class="base-num num6">${eventNum}</p><p class="base-desc">理赔通过数</p></li>
                <li><p class="base-num num7">${eventMoney}</p><p class="base-desc">理赔金额</p></li>
            </ul>
        </div>
        <div class="user-count">
            <a id="userNum" class="user-type" href="javascript:;" onclick="javascript:;">用户(10)</a>
            <a id="businessNum" class="user-type" href="javascript:;" onclick="javascript:;">商家(10)</a>
            <a id="channelNum" class="user-type active" href="javascript:;" onclick="javascript:;">其他渠道(10)</a>
        </div>
        <div class="user-table">
            <table class="table1"></table>
        </div>
        <p class="ttile"><strong>全局数据</strong></p>
        <ul class="base-data clearfix">
          <li><p class="p1">用户成本</p><p class="p2"><span class="p1"></span>　</p><p class="p2 base-num2 num1">-</p></li>
          <li><p class="p1">平均充值金额</p><p class="p2"><span class="p1"></span>　</p><p class="p2 base-num2 num2">-</p></li>
          <li><p class="p1">平均保障中天数</p><p class="p2"><span class="p1"></span>　</p><p class="p2 base-num2 num3">-</p></li>
          <li><p class="p1">平均理赔金额</p><p class="p2"><span class="p1"></span>　</p><p class="p2 base-num2 num4">-</p></li>
          <li><p class="p1">待支付</p><p class="p2"><span class="p1">数量　</span><span class="base-num2 num5">-</span></p><p class="p2"><span class="p1">占比　</span><span class="base-num2 num6">-</span></p></li>
          <li><p class="p1">余额不足数</p><p class="p2"><span class="p1">数量　</span><span class="base-num2 num7">-</span></p><p class="p2"><span class="p1">占比　</span><span class="base-num2 num8">-</span></p></li>
          <li><p class="p1">申请理赔次数</p><p class="p2"><span class="p1"></span>　</p><p class="p2 base-num2 num9">-</p></li>
        </ul>
        <div class="chart-box">
          <p class="chart-title"><strong>全局理赔概况</strong></p>
          <div class="chart-legend">
            <p><i class="chart-legend-icon i1"></i>理赔率</p>
            <p><i class="chart-legend-icon i2"></i>保障中车辆</p>
            <p><i class="chart-legend-icon i3"></i>理赔车辆</p>
          </div>
          <div class="chart-body chart1">
            <div class="chart-content"></div>
          </div>
        </div>
        <div class="chart-box b2 clearfix">
          <div class="chart-body chart2">
            <p class="chart-title-sub s2"><strong>受损部位</strong></p>
            <div class="chart-content">
              <canvas height="250"></canvas>
            </div>
          </div>
          <div class="chart-body chart3">
            <p class="chart-title-sub s2"><strong>理赔金额</strong></p>
            <div class="chart-content">
              <canvas height="250"></canvas>
            </div>
          </div>
          <div class="chart-body chart4">
            <p class="chart-title-sub s2"><strong>虚拟补贴</strong></p>
            <div class="chart-content">
              <canvas height="250"></canvas>
            </div>
          </div>
        </div>
        <div class="user-count">
            <p class="user-type">虚拟补贴</p>
        </div>
        <div class="user-table">
            <table class="table2"></table>
        </div>
        <div class="chart-box clearfix">
          <p class="chart-title"><strong>购买行为概况</strong></p>
          <div class="chart-body chart5">
            <div class="chart-content"></div>
          </div>
          <div class="chart-body chart6">
            <div class="chart-legend-sub">
              <p>复购次数：<span class="sum">-</span>次</p>
            </div>
            <div class="chart-content"></div>
          </div>
        </div>
        <div class="user-count">
            <p class="user-type">维修厂结算</p>
            <p class="user-arr"><span class="a1"></span><span class="a2"></span></p>
        </div>
        <div class="user-table">
            <table class="table3"></table>
        </div>
    </div>
</div>
<%--<div id="customTimeLayer" style="padding: 10px;">
    <p class="pull-left" style="line-height:34px;">起止时间</p>
    <input id="beginTime" value="" class="form-control pull-left" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'});" placeholder="选择开始时间" style="width:120px;margin-left:6px;">
    <p class="pull-left" style="line-height:34px;margin-left:6px;">-</p>
    <input id="endTime" value="" class="form-control pull-left" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'});" placeholder="选择结束时间" style="width:120px;margin-left:6px;">
</div>--%>
<!--新建活动模板 弹窗-->
<div class="update-lay-box" id="addLay">
    <div class="user-table">
        <table class="shop_table"></table>
    </div>
</div>
<script type="text/javascript">

   // --------------
   var chart1;
   var chart2;
   var chart3;
   var chart4;
   // 页面加载事件
   $(function($){

       // 获取全局数据
       $.getJSON("${ctx}/chart/test1", function(datas){
           if(datas.code == "200"){
               var result = datas.data;
               $('.base-num2.num1').text(result.userCost); // 用户成本
               $('.base-num2.num2').text(result.avgRecharge); // 平均充值金额
               $('.base-num2.num3').text(result.avgGuaranteeNum); // 平均保障中天数
               $('.base-num2.num4').text(result.avgEventAmt); // 平均理赔金额
               $('.base-num2.num5').text(result.toPay); // 待支付数量
               $('.base-num2.num6').text(result.toPayPer); // 待支付占比
               $('.base-num2.num7').text(result.noBanlance); // 余额不足数量
               $('.base-num2.num8').text(result.noBanlancePer); // 余额不足占比
               $('.base-num2.num9').text(result.eventNum); // 申请理赔次数
           }
        });

       // 全局理赔概况统计表
       $.getJSON("${ctx}/chart/test2", function(datas){
           if(datas.code == "200"){
               var result = datas.data;
               // 统计的月份
               var chart1_labels = result.month;
               // 理赔率
               var chart1_data1 = result.eventPer;
               // 保障中车辆
               var chart1_data2 = result.guaranteeNum;
               // 理赔车辆
               var chart1_data3 = result.eventNum;

               // 设置第一个统计图表的缩放起止范围
               var chart1_data_num = 12;  // 一屏显示的数据条数
               var chart1_start = null;
               var chart1_end = null;
               if (chart1_labels.length > chart1_data_num) {
                   chart1_start = chart1_labels.length - chart1_data_num;
                   chart1_end = chart1_labels.length - 1;
               }

                // 渲染第一个统计图表(全局理赔概况)
               chart1 = echarts.init($('.chart1 .chart-content')[0]);
               chart1.setOption({
                   grid: {
                       left: 20,
                       right: 20,
                       top: 50,
                       bottom: 60
                   },
                   tooltip: {
                       show: true
                   },
                   dataZoom: [{
                       id: 'dataZoomX',
                       type: 'inside',
                       xAxisIndex: 0,
                       filterMode: 'filter',
                       startValue: chart1_start,
                       endValue: chart1_end
                   }],
                   xAxis: {
                       data: chart1_labels,
                       axisLine: {
                           lineStyle: {
                               type: 'dashed',
                               color: '#b5b5b5'
                           }
                       },
                       axisLabel: {
                           color: '#434141'
                       },
                       axisTick: {
                           show: false
                       }
                   },
                   yAxis: [{
                       show: false
                   }, {
                       splitLine: {
                           lineStyle: {
                               color: '#d7d5d5',
                               type: 'dashed'
                           }
                       },
                       axisLine: {
                           show: false
                       },
                       axisTick: {
                           show: false
                       },
                       axisLabel: {
                           show: false
                       }
                   }],
                   series: [{
                       name: '理赔率',
                       type: 'line',
                       data: chart1_data1,
                       itemStyle: {
                           color: '#fdab22'
                       },
                       label: {
                           show: true,
                           fontSize: 14,
                           formatter: '{c}%'
                       },
                       tooltip: {
                           formatter: '{b}{a}:{c}%'
                       }
                   }, {
                       name: '保障中车辆',
                       type: 'bar',
                       data: chart1_data2,
                       barWidth: '30%',
                       barGap: '-100%',
                       itemStyle: {
                           color: '#eef3f9'
                       },
                       label: {
                           show: true,
                           color: '#434141',
                           fontSize: 14,
                           position: 'top',
                           formatter: '{c}辆'
                       },
                       tooltip: {
                           formatter: '{b}{a}:{c}辆'
                       },
                       emphasis: {
                           itemStyle: {
                               color: '#cfd6de'
                           }
                       },
                       yAxisIndex: 1
                   }, {
                       name: '理赔车辆',
                       type: 'bar',
                       data: chart1_data3,
                       barWidth: '30%',
                       itemStyle: {
                           color: '#5799f6'
                       },
                       label: {
                           show: true,
                           fontSize: 14,
                           position: 'top',
                           formatter: '{c}辆'
                       },
                       tooltip: {
                           formatter: '{b}{a}:{c}辆'
                       },
                       z: 10,
                       yAxisIndex: 1
                   }]
               });
           }
       });


       // 受损部位统计图
       $.getJSON("${ctx}/chart/test6", function(datas){
           if(datas.code == "200"){
               // 渲染第二个统计图表(受损部位)
               var chart2_data = datas.data;
               chart2 = echarts.init($('.chart2 .chart-content')[0]);
               chart2.setOption({
                   color: ['#1ad1fa', '#65d6f0', '#8de1f4', '#7de7fe'],
                   tooltip: {
                       formatter: '{b}:{c}起 {d}%'
                   },
                   series: [{
                       name: '受损部位',
                       type: 'pie',
                       data: chart2_data,
                       minAngle: 15,
                       radius: ['40%', '90%'],
                       itemStyle: {
                           borderWidth: 3,
                           borderColor: '#fff'
                       },
                       label: {
                           show: true,
                           position: 'inside',
                           fontSize: 14,
                           color: '#434141',
                           formatter: '{b} {c}起\n{d}%'
                       }
                   }]
               });
           }

       });

       // 渲染第三个统计图表(理赔金额)
       $.getJSON("${ctx}/chart/test3", function(datas){
           if(datas.code == "200"){
               // 理赔金额统计图
               var chart3_data = datas.data;
               chart3 = echarts.init($('.chart3 .chart-content')[0]);
               chart3.setOption({
                   color: ['#16d4cd', '#fba801', '#fec904', '#7f7ce8', '#21b8ea'],
                   tooltip: {
                       formatter: '{b}:{c}笔 {d}%'
                   },
                   series: [{
                       name: '理赔金额',
                       type: 'pie',
                       data: chart3_data,
                       minAngle: 15,
                       radius: ['40%', '90%'],
                       itemStyle: {
                           borderWidth: 3,
                           borderColor: '#fff'
                       },
                       label: {
                           show: true,
                           position: 'inside',
                           fontSize: 14,
                           color: '#434141',
                           formatter: '{b}\n{c}笔 {d}%'
                       }
                   }]
               });
           }
       });



       // 渲染第四个统计图表(虚拟补贴)
       $.getJSON("${ctx}/chart/test4", function(datas){
           if(datas.code == "200") {
               // 虚拟补贴统计图
               var chart4_data = datas.data;
               chart4 = echarts.init($('.chart4 .chart-content')[0]);
               chart4.setOption({
                   color: ['#1ad1fa', '#65d6f0', '#8de1f4', '#7de7fe'],
                   tooltip: {
                       formatter: '{b}:{c}笔 {d}%'
                   },
                   series: [{
                       name: '虚拟补贴',
                       type: 'pie',
                       data: chart4_data,
                       minAngle: 15,
                       radius: ['40%', '90%'],
                       itemStyle: {
                           borderWidth: 3,
                           borderColor: '#fff'
                       },
                       label: {
                           show: true,
                           position: 'inside',
                           fontSize: 14,
                           color: '#434141',
                           formatter: '{b} {c}笔\n{d}%'
                       }
                   }]
               });
           }
       });

       // 服务商结算排行榜表格
       $.getJSON("${ctx}/chart/test5?index=1", function(datas){
           var chart4_data = datas.data;
           var table3_titles_per = [10, 30, 15, 15, 15, 15];
           var table3_titles = ['排名', '昵称/名称', '可用金额', '冻结金额', '总金额', '已提现金'];
           var table3_data =  new Array();
           $.each(chart4_data,function(i,v){
               table3_data[i] =  [i+1,v.shopName,v.amtFreeze,v.amtUnfreeze,v.amtTotal,v.amtPaid];
            });
           $('.table3').html(createTable(table3_titles_per, table3_titles, table3_data));
       });
   });
   //---------------
   $('.user-arr').click(function(){
       alert("asdfasf")

       layer.open({
           type:1,
           // area: ["auto", "auto"],
           title:'服务商结算排行榜',
           shade: 0.3,//遮罩透明度，或false没有遮罩
           closeBtn:'1',
           btn:['确定','取消'],
           anim: 5,
           shadeClose: true, //点击遮罩关闭
           content: $('#addLay'),
           yes:function(){
               $.getJSON("${ctx}/chart/test5?index=2", function(datas){
                   var chart4_data = datas.data;
                   var table3_titles_per = [10, 30, 15, 15, 15, 15];
                   var table3_titles = ['排名', '昵称/名称', '可用金额', '冻结金额', '总金额', '已提现金'];
                   var table3_data =  new Array();
                   $.each(chart4_data,function(i,v){
                       table3_data[i] =  [i+1,v.shopName,v.amtFreeze,v.amtUnfreeze,v.amtTotal,v.amtPaid];
                   });
                   $('.shop_table').html(createTable(table3_titles_per, table3_titles, table3_data));
               });
           }
       });

   });


//----------------------------------------------------------------------------------------------------------------------------
// 拉新排行榜表格
var table1_titles_per = [5, 25, 13, 13, 13, 13, 18];  // 每列宽度占比
var table1_titles = ['排名', '昵称/名称', '关注数', '注册数', '观察期车辆', '保障中车辆',	'占比（观察期+保障中）'];
var table1_data = [
  [1, '万车达',	1664,	1912,	135, 1292, '37%'],
  [2, '丰融保险部',	1664,	1912,	135, 1292, '37%'],
  [3, 'e泊车',	1664,	1912,	135, 1292, '37%'],
  [4, '鑫茂益汽车',	1664,	1912,	135, 1292, '37%'],
  [5, '车险服务部',	1664,	1912,	135, 1292, '37%'],
  [6, '车管家',	1664,	1912,	135, 1292, '37%'],
  [7, '欣立保险',	1664,	1912,	135, 1292, '37%'],
  [8, 'FM92.5',	1664,	1912,	135, 1292, '37%'],
  [9, '曾波',	1664,	1912,	135, 1292, '37%'],
  [10, '车V互助福利一群',	1664,	1912,	135, 1292, '37%']
];

// 虚拟补贴排行榜表格
var table2_titles_per = [5, 35, 20, 10, 20, 10];
var table2_titles = ['排名', '渠道', '金额', '占比', '理赔金额', '理赔率'];
var table2_data = [
  [1, '万车达',	1664,	'12%', 1292, '37%'],
  [2, '丰融保险部',	1664,	'12%',1292, '37%'],
  [3, 'e泊车',	1664,	'12%', 1292, '37%'],
  [4, '鑫茂益汽车',	1664,	'12%', 1292, '37%'],
  [5, '车险服务部',	1664,	'12%', 1292, '37%'],
  [6, '车管家',	1664,	'12%', 1292, '37%'],
  [7, '欣立保险',	1664,	'12%', 1292, '37%'],
  [8, 'FM92.5',	1664,	'12%', 1292, '37%'],
  [9, '曾波',	1664,	'12%', 1292, '37%'],
  [10, '车V互助福利一群',	1664,	'12%', 1292, '37%']
];

/*
// 服务商结算排行榜表格
var table3_titles_per = [5, 25, 13, 13, 13, 18, 13];
var table3_titles = ['排名', '昵称/名称', '观察期数量', '保障中数量', '理赔通过数量', '理赔金额',	'理赔率'];
var table3_data = [
  [1, '万车达',	1664,	1912,	135, 1292, '37%'],
  [2, '丰融保险部',	1664,	1912,	135, 1292, '37%'],
  [3, 'e泊车',	1664,	1912,	135, 1292, '37%'],
  [4, '鑫茂益汽车',	1664,	1912,	135, 1292, '37%'],
  [5, '车险服务部',	1664,	1912,	135, 1292, '37%'],
  [6, '车管家',	1664,	1912,	135, 1292, '37%'],
  [7, '欣立保险',	1664,	1912,	135, 1292, '37%'],
  [8, 'FM92.5',	1664,	1912,	135, 1292, '37%'],
  [9, '曾波',	1664,	1912,	135, 1292, '37%'],
  [10, '车V互助福利一群',	1664,	1912,	135, 1292, '37%']
];
*/




// 充值统计图
var chart5_data = [{name: '9元', value: 245}, {name: '99元', value: 129}];
// 复购统计图
var chart6_labels = ['付费车辆', '补贴车辆'];
var chart6_data = [29, 5];  // 复购率
var chart6_sum = 136;  // 复购次数
//----------------------------------------------------------------------------------------------------------------------------
// 构造表格的方法
var createTable = function(titles_per, titles, data) {
  var html = '';
  for (var i = 0, j = titles.length; i < j; i++) {
    if (i === 0) {
      html += '<tr class="user-table-title">';
    }
    html += '<th' + (titles_per[i] ? ' width="' + titles_per[i]  + '%"' : '') + '>' + titles[i] + '</th>';
    if (i + 1 === j) {
      html += '</tr>';
    }
  }
  for (var i = 0, j = data.length; i < j; i++) {
    var item = data[i];
    html += '<tr>';
    for (var m = 0, n = item.length; m < n; m++) {
      html += '<td>' + item[m] + '</td>';
    }
    html += '</tr>';
  }
  return html;
}
$('.table1').html(createTable(table1_titles_per, table1_titles, table1_data));
$('.table2').html(createTable(table2_titles_per, table2_titles, table2_data));
// $('.table3').html(createTable(table3_titles_per, table3_titles, table3_data));







// 渲染第五个统计图表(充值概况)
var chart5 = echarts.init($('.chart5 .chart-content')[0]);
chart5.setOption({
    title: {
        text: '充值',
        padding: [10, 5, 5, 20],
        textStyle: {
            fontSize: 16
        }
    },
    color: ['#8b85e0', '#feca03'],
    tooltip: {
        formatter: '{b}充值:{c}笔 {d}%'
    },
    series: [{
        name: '充值',
        type: 'pie',
        data: chart5_data,
        minAngle: 15,
        itemStyle: {
            borderWidth: 3,
            borderColor: '#fff'
        },
        label: {
            show: true,
            position: 'inside',
            fontSize: 14,
            color: '#434141',
            formatter: '{b}充值\n{c}笔 {d}%'
        }
    }]
});

// 渲染第六个统计图表(复购率)
var chart6 = echarts.init($('.chart6 .chart-content')[0]);
chart6.setOption({
    title: {
        text: '复购率',
        padding: [10, 5, 5, 20],
        textStyle: {
            fontSize: 16
        }
    },
    tooltip: {
        formatter: '{b}:{c}%'
    },
    grid: {
        left: 20,
        right: 20,
        top: 50,
        bottom: 60
    },
    xAxis: {
        data: chart6_labels,
        axisLine: {
            lineStyle: {
                type: 'dashed',
                color: '#b5b5b5'
            }
        },
        axisLabel: {
            color: '#434141'
        },
        axisTick: {
            show: false
        }
    },
    yAxis: {
        splitLine: {
            lineStyle: {
                color: '#d7d5d5',
                type: 'dashed'
            }
        },
        axisLine: {
            show: false
        },
        axisTick: {
            show: false
        },
        axisLabel: {
            show: false
        }
    },
    series: [{
        name: '复购率',
        type: 'bar',
        data: chart6_data,
        barWidth: '30%',
        itemStyle: {
          color: '#90bbf9'
        },
        label: {
            show: true,
            fontSize: 14,
            formatter: '{c}%'
        }
    }]
});

// 给所有统计图表添加自适应性
window.addEventListener("resize", function() { 
    this.chart1.resize();
    this.chart2.resize();
    this.chart3.resize();
    this.chart4.resize();
    this.chart5.resize();
    this.chart6.resize();
});

// 渲染部分数据
/* for (var i = 1; i < 8; i++) {
  $('.base-num.num' + i).text(1000);  // 顶部7个数字
} */
/*for (var i = 1; i < 10; i++) {
  $('.base-num2.num' + i).text(45);  // 全局数据的9个数字
}*/
$('.chart6 .sum').text(chart6_sum);  // 复购次数

// 切换拉新统计的对象（用户/商家/渠道）
$('.user-count').on('click', 'a', function(){
    $(this).addClass('active').siblings().removeClass('active');
    //-----ajax请求数据后重新对table1_data赋值-----
    //table1_data = [...];
    //$('.table1').html(createTable(table1_titles_per, table1_titles, table1_data));
})

// 切换日期
$('.datebox-btn').on('click', 'a', function(){
    var $this = $(this);
    var name = $this.text();
    $this.closest('.datebox-btn').find('.btn-title').text(name);
})
</script>
</body>
</html>