'use strict';

(function () {
  var loading = false;
  var user = checkLogin(true);

  if (user) {
    loadList(true);
  }

  // 获取优惠券列表
  function loadList() {
    if (loading) return;
    showLoad();
    loading = true;
    goAPI({
      url: _api.carwash_coupon,
      data: {
        token: user.token
      },
      success: function success(data) {
        data = data.data;
        if (!$.isArray(data)) {
          data = [];
        }
        $('.container').html(juicer($('#main-tpl').html(), data));
        $('.container').on('click', '.btn-use', function () {
          showConfirm({
            str: '请识别二维码前往【懒人洗车】平台激活',
            node: '<img src="/hfive/img/xiaochengxu_xiongbao.jpg" style="width:3rem;">'
          });
        }).on('click', '.btn-rule', function () {
          showConfirm({
            title: '使用说明',
            class: 'tl',
            str: '1、补贴活动为车V互动V2会员专属特权；\n2、使用有效期截至2019-02-01。'
          });
        });
      },
      error: function error(msg) {
        showConfirm({
          str: msg,
          btn_yes: {
            str: '重新加载',
            event_click: function event_click() {
              loadList();
            }
          }
        });
      },
      complete: function complete() {
        hideLoad();
        loading = false;
      }
    });
  }
})();