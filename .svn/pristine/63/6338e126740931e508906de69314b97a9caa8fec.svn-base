package com.zccbh.demand.service.marketing;

import java.math.BigDecimal;
import java.util.*;
import java.util.concurrent.*;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.zccbh.demand.mapper.business.AccountMapper;
import com.zccbh.demand.mapper.system.ChartMapper;
import com.zccbh.util.base.LocalThreadPool;
import com.zccbh.util.base.NormalUtils;
import com.zccbh.util.collect.Constant;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.zccbh.demand.mapper.customer.RecordRechargeMapper;
import com.zccbh.demand.mapper.customer.UserCustomerMapper;
import com.zccbh.demand.mapper.customer.WechatLoginMapper;
import com.zccbh.demand.mapper.event.EventMapper;

/**
 * @author xiaowuge
 * @ClassName: MarketingService
 * @Description: TODO(这里用一句话描述这个类的作用)
 * @date 2018年10月25日 下午4:32:27
 */
@Service
@Transactional(propagation = Propagation.SUPPORTS, readOnly = true)
public class MarketingService {

    @Autowired
    private WechatLoginMapper wechatLoginMapper;
    @Autowired
    private UserCustomerMapper userCustomerMapper;
    @Autowired
    private RecordRechargeMapper recordRechargeMapper;
    @Autowired
    private EventMapper eventMapper;
    @Autowired
    private ChartMapper chartMapper;
    @Autowired
    private AccountMapper accountMapper;

    @Transactional
    public Map<String, Object> localShow(Map<String, Object> parameMap) throws Exception {
        Map<String, Object> resultMap = new HashMap<>();
        Map<String, Object> concernWeChat = wechatLoginMapper.concernWeChat(parameMap);
        resultMap.put("weChatConcernNum", concernWeChat.get("concernWeChat"));
        Map<String, Object> userRegister = userCustomerMapper.getRegisterNum(parameMap);
        resultMap.put("registerNum", userRegister.get("registerNum"));
        Map<String, Object> carInfo = wechatLoginMapper.selectObservationAndGuarantee(parameMap);
        resultMap.put("observationNum", carInfo.get("observationNum"));
        resultMap.put("guaranteeNum", carInfo.get("guaranteeNum"));
        Map<String, Object> rechargeInfo = recordRechargeMapper.marketingRecharge(parameMap);
//		resultMap.put("amtRcharge", rechargeInfo.get("amtRcharge"));
        resultMap.put("rechargeNum", rechargeInfo.get("rechargeNum"));
        Map<String, Object> eventResultInfo = eventMapper.eventResult(parameMap);
        resultMap.put("eventMoney", eventResultInfo.get("eventMoney"));
        resultMap.put("eventNum", eventResultInfo.get("eventNum"));
        return resultMap;
    }


    /**
     * 全局数据
     *
     * @return
     */
    public Map<String, Object> globalDate() {
        Map<String, Object> out = new HashMap<>();
        Collection<Callable<Map<String, Object>>> taskList = new ArrayList<>(7);
        taskList.add(this::userCost);
        taskList.add(this::avgRecharge);
        taskList.add(this::avgGuaranteeNum);
        taskList.add(this::avgEventAmt);
        taskList.add(this::toPay);
        taskList.add(this::noBanlance);
        taskList.add(this::eventNum);
        try {
            List<Future<Map<String, Object>>> futureList = LocalThreadPool.executorService.invokeAll(taskList);
            for (Future<Map<String, Object>> future : futureList) {
                out.putAll(future.get());
            }
//            executorService.shutdown();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        }
        return out;
    }

    // 用户成本
    private Map<String, Object> userCost() {
        Map<String, Object> rs = chartMapper.userCost();
        double userCost = NormalUtils.decimalToDouble((BigDecimal) rs.get("userCost"), true);
        // 正数说明没有用户成本
        if (userCost >= 0)
            rs.put("userCost", 0);
        else
            rs.put("userCost", -userCost);
        return rs;
    }

    // 平均充值金额
    public Map<String, Object> avgRecharge() {
        Map<String, Object> rs = chartMapper.avgRecharge();
        rs.put("avgRecharge", NormalUtils.decimalToDouble((BigDecimal) rs.get("avgRecharge"), true));
        return rs;
    }

    // 平均保障中天数
    public Map<String, Object> avgGuaranteeNum() {
        Map<String, Object> rs = chartMapper.avgGuaranteeNum();
        rs.put("avgGuaranteeNum", NormalUtils.decimalToInt((BigDecimal) rs.get("avgGuaranteeNum"), NormalUtils.ADD_ONE));
        return rs;
    }

    // 平均理赔金额
    public Map<String, Object> avgEventAmt() {
        Map<String, Object> rs = chartMapper.avgEventAmt();
        rs.put("avgEventAmt", NormalUtils.decimalToDouble((BigDecimal) rs.get("avgEventAmt"), true));
        return rs;
    }

    // 待支付,占比
    public Map<String, Object> toPay() {
        Map<String, Object> rs = chartMapper.toPay();
        BigDecimal toPayPer = (BigDecimal) rs.get("toPayPer");
        toPayPer = toPayPer.multiply(new BigDecimal(100));
        rs.put("toPayPer", NormalUtils.decimalToDouble(toPayPer, true) + "%");
        return rs;
    }

    // 余额不足数,占比
    public Map<String, Object> noBanlance() {
        Map<String, Object> rs = chartMapper.noBanlance();
        BigDecimal noBanlancePer = (BigDecimal) rs.get("noBanlancePer");
        noBanlancePer = noBanlancePer.multiply(new BigDecimal(100));
        rs.put("noBanlancePer", NormalUtils.decimalToDouble(noBanlancePer, true) + "%");
        return rs;
    }

    // 申请理赔次数
    public Map<String, Object> eventNum() {
        Map<String, Object> rs = chartMapper.eventNum();
//        rs.put("eventNum", Integer.valueOf(rs.get("eventNum").toString()));
        return rs;
    }


    /**
     * 全局理赔概况
     *
     * @return
     */
    public Map<String, Object> globalClaimsAnalysis() {
        Map<String, Object> out = new HashMap<>();
        // 截止每个月保障中车辆
        Map<String, Object> monthRs = chartMapper.getGuaranteeNumByMonth();
        String str = (String) monthRs.get("guaranteeNum");
        String[] guaranteeNums = str.split(",");
        out.put("guaranteeNum", guaranteeNums);
        // 每个月理赔车辆 ,定损通过的
        String rs = chartMapper.eventNumByMonth();
        List<Object> months = new ArrayList<>();
        List<Object> eventNos = new ArrayList<>();
        String[] temp = rs.split(",");
        for (String event : temp) {
            String[] tempp = event.split("-");
            months.add(tempp[0]);
            eventNos.add(tempp[1]);
        }
        out.put("month", months);
        out.put("eventNum", eventNos);
        // 理赔率
        Double[] eventPer = new Double[guaranteeNums.length];
        for (int i = 0; i < guaranteeNums.length; i++) {
            double d = Long.valueOf(eventNos.get(i).toString()) / NormalUtils.stringToDouble(guaranteeNums[i], true) * 100;
            eventPer[i] = new BigDecimal(d).setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue();
        }

        out.put("eventPer", eventPer);
        return out;
    }

    /**
     * 理赔金额比例
     *
     * @return
     */
    public List<Map<String, Object>> eventAmt() {
        List<Map<String, Object>> rs = chartMapper.eventAmt();
//		LOGGER.debug("理赔金额比例:{}", rs);
        rs.forEach(map -> map.replace("name", map.get("name").toString().substring(2)));
//		LOGGER.debug("理赔金额比例:{}", rs);
        return rs;
    }

    /**
     * 虚拟补贴
     *
     * @return
     */
    public List<Map<String, Object>> rechargeNum() {
        List<Map<String, Object>> rs = chartMapper.rechargeNum();
//		LOGGER.debug(" 虚拟补贴比例debug:{}", rs);
        return rs;
    }


    /**
     * 维修厂结算数据
     *
     * @return
     */
    public List<Map<String, Object>> maintenanceshopAmt(Integer index) {
        List<Map<String, Object>> accountList = null;
        try {
            accountList = accountMapper.findMore(new HashMap<>());
            for (Map<String, Object> account : accountList) {
                String amtUnfreeze = Constant.toOr((String) account.get("amtUnfreeze"), Constant.toReadPro("orKey"), "decrypt");
                Double amtUnfreezeT = NormalUtils.stringToDouble(amtUnfreeze, true);
                String amtFreeze = Constant.toOr((String) account.get("amtFreeze"), Constant.toReadPro("orKey"), "decrypt");
                Double amtFreezeT = NormalUtils.stringToDouble(amtFreeze, true);
                account.put("amtTotal", new BigDecimal(amtUnfreeze).add(new BigDecimal(amtFreeze)));
                account.put("amtUnfreeze", amtUnfreezeT);
                account.put("amtFreeze", amtFreezeT);
            }
            Collections.sort(accountList, (o1, o2) -> {
                Double amtUnfreeze2 = (Double) o2.get("amtFreeze");
                Double amtUnfreeze1 = (Double) o1.get("amtFreeze");
                return amtUnfreeze2.compareTo(amtUnfreeze1);
            });
        } catch (Exception e) {
            e.printStackTrace();
        }
//        PageInfo<Map<String, Object>> accountInfo = new PageInfo<>(accountList.subList(0,9));
//		LOGGER.debug("返回结果：{}", index);
        if (1 == index)
            return accountList.subList(0, 10);
        else if (2 == index)
            return accountList;
        else
            throw new RuntimeException("参数错误!");
    }

    /**
     * 维修厂结算数据
     *
     * @return
     */
    public PageInfo<Map<String, Object>> maintenanceshopBill(Map<String, Object> paramModelMap) throws Exception {
        int pageNo = Constant.toEmpty(paramModelMap.get("pageNo")) ? Integer.parseInt(paramModelMap.get("pageNo").toString()) : 1;
        int pageSize = Constant.toEmpty(paramModelMap.get("pageSize")) ? Integer.parseInt(paramModelMap.get("pageSize").toString()) : 10;
        PageHelper.startPage(pageNo, pageSize);
        List<Map<String, Object>> accountList = accountMapper.findMore(new HashMap<>());
        for (Map<String, Object> account : accountList) {
            String amtUnfreeze = Constant.toOr((String) account.get("amtUnfreeze"), Constant.toReadPro("orKey"), "decrypt");
            Double amtUnfreezeT = NormalUtils.stringToDouble(amtUnfreeze, true);
            String amtFreeze = Constant.toOr((String) account.get("amtFreeze"), Constant.toReadPro("orKey"), "decrypt");
            Double amtFreezeT = NormalUtils.stringToDouble(amtFreeze, true);
            account.put("amtTotal", new BigDecimal(amtUnfreeze).add(new BigDecimal(amtFreeze)));
            account.put("amtUnfreeze", amtUnfreezeT);
            account.put("amtFreeze", amtFreezeT);
        }
        Collections.sort(accountList, (o1, o2) -> {
            Double amtUnfreeze2 = (Double) o2.get("amtFreeze");
            Double amtUnfreeze1 = (Double) o1.get("amtFreeze");
            return amtUnfreeze2.compareTo(amtUnfreeze1);
        });
        return new PageInfo<>(accountList);
    }

    /**
     * 受损部位统计
     *
     * @return
     */
    public List<Map<String, Object>> getDamagePosition() {
        List<Map<String, Object>> out = new ArrayList<>();
        String rs = chartMapper.getDamagePosition();
//		LOGGER.debug(" 受损部位统计:{}", rs);
        String[] position_count = rs.split(",");
        String[] name = position_count[0].split("-");
        String[] value = position_count[1].split("-");
        for (int i = 0; i < name.length; i++) {
            Map<String, Object> map = new HashMap<>();
            map.put("name", name[i]);
            map.put("value", value[i]);
            out.add(map);
        }
        return out;
    }
}
