'use strict';

var loading = false;
var user = checkLogin(true);
var user_data;
var share_url = '';
var money_base = 1000;
var money_max = 1500;
var money_reward = 125;
var avatar_loaded = false;
var qrcode_loaded = false;

if (user) {
  loadData();
}

function loadData() {
  showLoad();
  loading = true;
  goAPI({
    url: _api.user,
    data: {
      token: user.token
    },
    success: function success(data) {
      user_data = data.data;
      goAPI({
        url: _api.user_other,
        data: {
          customerId: user_data.id
        },
        success: function success(data) {
          loading = false;
          var dt = data.data;
          // share_url = 'http://test.chevhuzhu.com/hfive/view/event_join2.html?id=' + user_data.id;
          // if (_config.is_wx) {
          // configWXJSSDK(_config.wx_share, {
          // success: function() {
          // shareWX({
          // title: user_data.userName + '邀你免费领取1000元小擦刮维修补贴金',
          // desc: user_data.userName + '邀你免费领取1000元小擦刮维修补贴金',
          // link: share_url
          // })
          // }
          // })
          // }
          // dt.portrait = dt.portrait.replace(/http:\/\/thirdwx.qlogo.cn\//, '/wechat_image/');
          if (!dt.qrcode) {
            qrcode_loaded = true;
          }
          $('#container').html(juicer($('#main-tpl').html(), dt));
          $('#btn-rule').on('click', function () {
            showConfirm({
              class: 'tl',
              title: '会员特权',
              str: '分享海报邀请朋友扫码免费领取' + money_base + '元擦挂维修金，并关注公号添加车牌；平台自动为Ta充值基础互助金，30天观察期后可开始限时体验擦挂维修。\n\n福利一：\n邀请满4名好友即可获得1元购买洗车活动(限购2次)；\n\n福利二：\n每邀请一位朋友加入，自己的维修额度提升' + money_reward + '元，最多增加' + money_reward * 4 + '提升至' + (money_base + money_reward * 4) + '元；\n\n福利三：\n每邀请一位朋友加入，平台为你自己的账户充值3元互助金。',
              cover_close: true
            });
          });
        },
        error: function error(data) {
          loading = false;
          hideLoad();
          showConfirm({
            str: data,
            btn_yes: {
              str: '重新加载',
              event_click: loadData
            }
          });
        }
      });
    },
    error: function error(data) {
      hideLoad();
      loading = false;
      showConfirm({
        str: data,
        btn_yes: {
          str: '重新加载',
          event_click: loadData
        }
      });
    }
  });
}

// 等用户头像和二维码都加载完毕后再触发生成图片
function showAvatar(obj) {
  resetImg(obj);
  avatar_loaded = true;
  showImg();
}

function showQrcode() {
  qrcode_loaded = true;
  showImg();
}

function showImg() {
  if (avatar_loaded && qrcode_loaded) {
    createImg(function () {
      $('#text1').addClass('hide');
      $('#qr').addClass('hide');
      $('#source').addClass('upper');
      $('#container').addClass('red');
      hideLoad();
    });
  }
}

// 生成图片
function createImg(cbk) {
  setTimeout(function () {
    $('#main').height($('#main').height());
    $('#source').height($('#main').height());
    $('.avatar img').removeAttr('onload');
    $('#qr img').removeAttr('onload');
    var dom = $('#main');
    var width = dom.width();
    var height = dom.height();
    var type = "png";
    var scaleBy = 1;
    var canvas = document.createElement('canvas');
    var rect = dom.get(0).getBoundingClientRect();
    canvas.width = width * scaleBy;
    canvas.height = height * scaleBy;
    canvas.style.width = width * scaleBy + 'px';
    canvas.style.height = height * scaleBy + 'px';
    var context = canvas.getContext('2d');
    context.scale(scaleBy, scaleBy);
    context.translate(-rect.left, -rect.top - $('#container').scrollTop());
    html2canvas(dom[0], {
      canvas: canvas,
      useCORS: true,
      onrendered: function onrendered(canvas) {
        $('#source').append($('<img>', { 'class': 'view', 'src': canvas.toDataURL('image/png') }));
        if ($('#source .view').length > 1) {
          $('#source .view:eq(0)').remove();
        }
        if ($.isFunction(cbk)) {
          cbk();
        }
      }
    });
  }, 300);
}