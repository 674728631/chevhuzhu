package com.zccbh.demand.controller.quartz;

import com.zccbh.demand.service.basic.DictionaryService;
import com.zccbh.demand.service.customer.CarService;
import com.zccbh.demand.service.event.EventService;
import com.zccbh.demand.service.weChat.SpringContextHolder;
import com.zccbh.demand.service.weChat.WeiXinUtils;
import com.zccbh.util.base.DateUtils;
import com.zccbh.util.base.MapUtil;
import com.zccbh.util.collect.Constant;
import org.quartz.*;
import org.springframework.scheduling.quartz.SchedulerFactoryBean;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;


/**
 * 处理定时调度任务的统一入口
 * @author nixianhua
 *
 */
public class ObservationJob implements Job{

	@Override
	public void execute(JobExecutionContext context)
			throws JobExecutionException {
		System.out.println("【定时任务】开始......");
		JobDataMap jobDataMap = context.getJobDetail().getJobDataMap();
		Map<String, Object> params = (Map<String, Object>) jobDataMap.get("params");
		SchedulerFactoryBean schedulerFactory = SpringContextHolder.getBean(SchedulerFactoryBean.class);
		Scheduler sche = schedulerFactory.getScheduler();
		String jobName = params.get("jobName").toString();
		WeiXinUtils weiXinUtils = SpringContextHolder.getBean(WeiXinUtils.class);
		CarService carService = SpringContextHolder.getBean(CarService.class);
		EventService eventService = SpringContextHolder.getBean(EventService.class);
		DictionaryService dictionaryService = SpringContextHolder.getBean(DictionaryService.class);
		try {
			Map map = new HashMap();
			//修改车辆保障时间
			Map<String, Object> carMap = carService.findCarById(new Integer(params.get("carId").toString()));
			String typeGuarantee = Constant.toEmpty(carMap.get("typeGuarantee"))?carMap.get("typeGuarantee").toString():params.get("typeGuarantee").toString();
			if (Constant.toEmpty(carMap.get("messageFlag"))) {
				Integer messageFlag = (Integer)carMap.get("messageFlag");
				if(Constant.toEmpty(params.get("openid"))){
					if(messageFlag==5 || messageFlag==7){
						map.put("messageFlag", 2);
					}
				}else {
					if(messageFlag==5){
						map.put("messageFlag", 7);
					}
				}
			}
			if(carMap.get("timeBegin") != null && DateUtils.getYearDate((Date)carMap.get("timeBegin")).compareTo(new Date()) == 1){
				map.put("timeEnd", "2".equals(typeGuarantee)?DateUtils.getYearDate((Date)carMap.get("timeBegin")):"");
			}else {
				map.put("timeBegin", DateUtils.getDateTime());
				map.put("timeEnd", "2".equals(typeGuarantee)?DateUtils.getYearDate(DateUtils.getDateTime()):"");
			}
			map.put("id", params.get("carId").toString());
			map.put("status",20);
			carService.updateCar(map);
			eventService.updateDayNumber("guaranteeNum",1);
			//删除定时任务
			QuartzUtils.removeJob(sche, jobName);
			//微信推送
			map.clear();
			System.out.println("观察期结束=====:  " + params);
			if (Constant.toEmpty(params.get("openid"))) {
//				map.put("openid", params.get("openid"));
//				map.put("content",params.get("content"));
//				map.put("keyword1", params.get("keyword1"));
//				map.put("keyword2", params.get("keyword2"));
//				map.put("url",params.get("url"));
//				weiXinUtils.sendTemplate(1, map);

				// 发送车辆进入保障的通知
				Map dictionary = dictionaryService.findSingle(MapUtil.build().put("type","observationTime").over());
				Map<String, String> param = new HashMap<>();
				param.put("openid", (String)params.get("openid"));
				param.put("licensePlateNumber", (String)carMap.get("licensePlateNumber"));
				param.put("observationTime",dictionary.get("value").toString());
				weiXinUtils.sendTemplate(13, param);
			}
			System.out.println("【定时任务】结束......");
		} catch (Exception e){
			e.printStackTrace();
		}
	}
}