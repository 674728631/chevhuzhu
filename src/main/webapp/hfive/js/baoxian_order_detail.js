"use strict";!function(){var e,t,o,n,a,i=!1,r=getUrlPar("id"),c=getUrlPar("mid"),s=checkLogin(!0),l=preview({fixed:!0,background:"#000000",number:!0,point:!0,fill:"fix"}),d=null,f={ads:""};function u(e){i||(showLoad(),i=!0,goAPI({url:_api.baoxian_order_pay,data:e,traditional:!0,success:function(e){wx.chooseWXPay({appId:e.data.appId,timestamp:e.data.timeStamp.toString(),nonceStr:e.data.nonceStr,package:e.data.package,signType:e.data.signType,paySign:e.data.paySign,success:function(e){showConfirm({str:"支付成功",btn_yes:{event_click:function(){window.location.reload()}}})}})},error:function(e){showConfirm({str:e})},complete:function(){hideLoad(),i=!1}}))}function p(e){i||(_config.is_wx_mobile?_config.wx_config?u(e):d=e:showConfirm({str:"请使用微信移动客户端打开该页面再进行支付"}))}function m(e,t){i||(showLoad(),i=!0,goAPI({url:_api.baoxian_order_report,data:e,success:function(e){$.isFunction(t)&&t()},error:function(e){showAlert(e)},complete:function(){hideLoad(),i=!1}}))}juicer.register("build_stime",function(e){var t=Math.floor(e/3600);if(t>0){var o=Math.ceil(e%3600/60);return o>=60?t+1+"小时":0===o?t+"小时":t+"小时"+o+"分"}return Math.ceil(e/60)+"分"}),s&&(r?function h(){showLoad();goAPI({url:_api.baoxian_order_detail,data:{token:s.token,orderNo:r,messageId:c},success:function(c){4!=(e=c.data).status||10==e.isInvalid?(_config.is_wx_mobile&&!_config.wx_config&&configWXJSSDK(["previewImage","chooseWXPay"].concat(_config.wx_share),{success:function(){d&&u(d)}}),e.labelContent?e.labelContent=e.labelContent.split("_"):e.labelContent=null,"string"===$.type(e.accidentImg)?e.accidentImg=e.accidentImg.split("_"):e.accidentImg||(e.accidentImg=[]),"string"===$.type(e.assertImg)?e.assertImg=e.assertImg.split("_"):e.assertImg||(e.assertImg=[]),"string"===$.type(e.repairImg)?e.repairImg=e.repairImg.split("_"):e.repairImg||(e.repairImg=[]),$(".container").html(juicer($("#main-tpl").html(),e)),10!=e.isInvalid&&function(e){var t=0;t=1==e||2==e?1:3==e||10==e||11==e||12==e||21==e?2:31==e||32==e?3:41==e||42==e?4:5;$(".step-box .point").each(function(e){e<t&&$(this).addClass("active")})}(e.status),$("#time").length>0&&function e(t){if(t>=0){var o,n=Math.floor(t/3600),a=Math.floor(t%3600/60),i=Math.floor(t%60);n>0?(o=n+"时",o+=a>9?a+"分":"0"+a+"分",o+=i>9?i+"秒":"0"+i+"秒"):a>0?(o=a+"分",o+=i>9?i+"秒":"0"+i+"秒"):o=i+"秒",$("#time").text(o),setTimeout(function(){e(t-1)},1e3)}else $("#time").text("已超时")}(e.interval),$(".photo-box").on("click",".photo-item",function(){var e=$(this),t=e.index(),o=[];e.closest(".photo-box").find(".photo-img img").each(function(){o.push($(this).attr("src"))}),_config.is_wx?_config.wx_config&&wx.previewImage({current:o[t],urls:o}):l.show({imgs:o,index:t+1})}),$("#map-confirm").on("click",function(){f.ads&&$("#caddress").val(f.ads),$("#map-layer").addClass("hide")}),$("#btn-confirm").on("click",function(){p({token:s.token,orderNo:e.orderNo})}),$("#btn-report").on("click",function(){showConfirm({class:"shadow-blue",cover_background:"rgba(255,255,255,0.5)",cover_close:!0,str:"亲，维修中我们有很多不足地方需要改进，感谢对车V互助的支持，请认真填写您的投诉内容，方便后续工作人员与您联系。",node:'<div id="report-box"><textarea id="report" class="fsize-14" maxlength="200" placeholder="亲，请填写您的投诉内容，方便我们工作人员核实处理！"></textarea><p id="report-status" class="tr">0/200</p></div>',event_init:function(){$("#report").off().on("input",function(){$("#report-status").text($("#report").val().length+"/200")})},btn_yes:{click_close:!1,event_click:function(){var t=$("#report").val().trim();0!==t.length?m({token:s.token,orderNo:e.orderNo,content:t},function(){showConfirm({str:"操作成功",btn_yes:{event_click:function(){window.location.reload()}}})}):showAlert("请填写投诉内容")}},btn_cancel:{str:"取消"}})}),$("#btn-resolve").on("click",function(){showConfirm({str:"您确定投诉问题已经解决并且确认维修中心已经交车给您了？",class:"shadow-blue",cover_background:"rgba(255,255,255,0.5)",cover_close:!0,btn_yes:{event_click:function(){m({token:s.token,orderNo:e.orderNo},function(){i=!1,p({token:s.token,orderNo:e.orderNo})})}},btn_cancel:{str:"取消"}})}),$("#btn-pay").on("click",function(){showConfirm({title:"亲，您确定维修中心已接车？",str:"维修中心人员来接车，请先核对下其身份",color:"#3196fe",class:"shadow-blue",cover_background:"rgba(255,255,255,0.5)",cover_close:!0,btn_yes:{event_click:function(){!function(e){if(i)return;showLoad(),i=!0,goAPI({url:_api.baoxian_order_confirm,data:e,success:function(e){showConfirm({str:"操作成功",btn_yes:{event_click:function(){window.location.reload()}}})},error:function(e){showConfirm({str:e})},complete:function(){hideLoad(),i=!1}})}({token:s.token,orderNo:e.orderNo})}},btn_cancel:{str:"取消"}})}),$("#btn-apply").on("click",function(){showConfirm({class:"shadow-blue contact",cover_background:"rgba(255,255,255,0.5)",node:'<div class="citem fbox-ac"><p>接车地址</p><div id="btn-address" class="ibox fbox-ac fbox-f1 hover"><input id="caddress" type="text" maxlength="100" value="'+f.ads+'" placeholder="点击打开地图" readonly></div></div><div class="citem fbox-ac"><p>联系人　</p><div class="ibox fbox-ac fbox-f1"><input id="cname" type="text" maxlength="50" placeholder="请输入联系人姓名" value="'+e.nameCarOwner+'"><a class="fbox-cc cdel hover hide" href="javascript:;"><span></span></a></div></div><div class="citem fbox-ac"><p>手机号　</p><div class="ibox fbox-ac fbox-f1"><input id="cphone" type="tel" maxlength="11" placeholder="请输入联系人手机号" value="'+s.phone+'"><a class="fbox-cc cdel hover hide" href="javascript:;"><span></span></a></div></div><div class="citem fbox-ac"><p>接车时间</p><div class="ibox fbox-ac fbox-f1"><input id="cdate" class="hover" type="text" maxlength="50" placeholder="请选择接车时间" value="" readonly><a class="fbox-cc cdel hover hide" href="javascript:;"><span></span></a></div></div>',btn_yes:{click_close:!1,event_click:function(){var e=$("#cname").val().trim(),t=$("#cphone").val().trim(),o=$("#cdate").val().trim();f.ads?0!==e.length?0!==t.length?validatePhone(t,!0)?0!==o.length?function(e){if(i)return;showLoad(),i=!0,goAPI({url:_api.baoxian_submit_contacter,data:e,success:function(e){showConfirm({str:"提交成功",btn_yes:{event_click:function(){window.location.reload()}}})},error:function(e){showAlert(e)},complete:function(){hideLoad(),i=!1}})}({token:s.token,orderNo:r,nameCarOwner:e,telCarOwner:t,reciveCarTime:o,place:f.ads,longitude:1e6*f.lng,latitude:1e6*f.lat}):showAlert("请选择接车时间"):showAlert("手机号格式有误"):showAlert("请填写手机号"):showAlert("请填写联系人"):showAlert("请选择接车地址")}},btn_cancel:{str:"取消"},event_init:function(){!function(){if(a)return;(a=new AMap.Map("map-main",{center:[104.065764,30.657462],zoom:14})).on("click",function(e){a.setCenter(e.lnglat),o&&o.getAddress(e.lnglat,function(t,o){"complete"===t&&(f={lat:e.lnglat.lat,lng:e.lnglat.lng,ads:o.regeocode.formattedAddress},$("#map-address").text(f.ads))}),n?n.setPosition(e.lnglat):n=new AMap.Marker({position:e.lnglat,map:a})}),a.plugin(["AMap.Geolocation","AMap.Geocoder","AMap.ToolBar","AMap.Scale"],function(){t=new AMap.Geolocation({enableHighAccuracy:!0,timeout:5e3,maximumAge:0,convert:!0,showButton:!0,buttonPosition:"LB",buttonOffset:new AMap.Pixel(10,20),showMarker:!0,showCircle:!0,panToLocation:!0,zoomToAccuracy:!0}),o=new AMap.Geocoder({batch:!1}),a.addControl(new AMap.ToolBar),a.addControl(new AMap.Scale),a.addControl(t),t.getCurrentPosition(),$("#map-address").text("自动定位中"),$("#caddress").val("自动定位中"),AMap.event.addListener(t,"complete",function(e){n?n.setPosition(e.position):n=new AMap.Marker({position:e.position,map:a}),f={lat:e.position.lat,lng:e.position.lng,ads:e.formattedAddress},$("#map-address").text(f.ads),$("#caddress").val(f.ads)}),AMap.event.addListener(t,"error",function(e){showAlert("定位失败，错误原因："+e.message),"自动定位中"===$("#map-address").text()&&$("#map-address").text("请选择当前位置"),$("#caddress").val("")})})}(),$("#btn-address").off().on("click",function(){$("#map-layer").removeClass("hide")}),$(".contact input").off().on("input",function(){var e=$(this),t=e.val().trim();t.length>0?e.siblings(".cdel").removeClass("hide"):e.siblings(".cdel").addClass("hide")}),$(".contact .cdel").off().on("click",function(){var e=$(this);e.addClass("hide").siblings("input").val("")}),$("#cdate").off().on("click",function(){var e={},t={},o={},n=[],a={},i={},r={},c=new Date,s=new Date(c.getFullYear(),c.getMonth(),c.getDate(),c.getHours()+3,c.getMinutes(),c.getSeconds()),l=new Date(c.getFullYear(),c.getMonth(),c.getDate(),12,0,0),d=new Date(c.getFullYear(),c.getMonth(),c.getDate(),17,59,59),f={},u={};s<l?s=l:s>d&&(s=null);for(var p=0;p<7;p++)if(0===p&&s||p>0){var m=new Date(c.getFullYear(),c.getMonth(),c.getDate()+p).formatDate("yyyy-MM-dd");a[p]={name:m}}for(var p=12;p<18;p++)i[p]={name:""+p};for(var p=0;p<60;p++)r[p]={name:p<10?"0"+p:""+p};if(s){for(var p=s.getHours();p<18;p++)f[p]={name:""+p};for(var p=s.getMinutes();p<60;p++)u[p]={name:p<10?"0"+p:""+p};n.push(a,f,u)}else n.push(a,i,r);var h=datapicker({class:"node",node:'<p class="time-title fbox-cc">预计接车时间</p><p class="time-txt fbox-cc"></p><div class="time-header fbox-ac"><p class="fbox-f1">日期<p/><p class="fbox-f1">时<p/><p class="fbox-f1">分</p></div>',event_scroll:function(e,t){s&&e[0].name===s.formatDate("yyyy-MM-dd")?(0===t?(n[1]=f,f[e[1].name]&&s.getHours()!=e[1].name?n[2]=r:n[2]=u):1===t&&(e[1].name==s.getHours()?n[2]=u:n[2]=r),h.show([e[0].value,e[1].value,e[2].value],n)):0===t?(n=[a,i,r],h.show([e[0].value,e[1].value,e[2].value],n)):$(".time-txt").text(e[0].name+"　"+e[1].name+":"+e[2].name)},event_show:function(n){e=n[0],t=n[1],o=n[2],$(".time-txt").text(n[0].name+"　"+n[1].name+":"+n[2].name)},event_ok:function(n){e=n[0],t=n[1],o=n[2],$("#cdate").val(e.name+" "+t.name+":"+o.name+":00")}});h.show([e.value,t.value,o.value],n)})}})})):window.location.href="/hfive/view/baoxian_order_add2.html?oid="+r},error:function(e){showConfirm({str:e,btn_yes:{str:"重新加载",event_click:h}})},complete:function(){hideLoad()}})}():showConfirm({str:"缺少订单ID",btn_yes:{str:"返回上一页",href:"javascript:history.go(-1);"},btn_no:{str:"回到首页",href:"/hfive/view/index.html"}}))}();